{{ $root := . }}
{{ $jsonpath := "" }}
{{- if .Values.global.yandexExporter.enabled }}
{{ $jsonpath = .Files.Glob "json_yandex/**.json"  }}
{{- else }}
{{ $jsonpath = .Files.Glob "json/**.json"  }}
{{- end }}
{{ range $path, $_ := $jsonpath  }}
{{- $fullpath := $path }}
{{- $directory := dir $path }} 
{{- $dir := index (regexSplit "json" (dir $path) -1) 1 }}
{{- $filename := base $path }}
{{- $dashboard := $filename | replace ".json" "" }}
{{- with $root }}
{{- if eq (toString .Values.global.provisioner) "deckhouse" }}
apiVersion: deckhouse.io/v1
kind: GrafanaDashboardDefinition
metadata:
  name: grafana-dashboard-{{ $filename | replace ".json" "" }}
  labels:
    prometheus.deckhouse.io/grafana-dashboard: ""
    module: monitoring
    tier: elma365
  annotations:
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
spec:
  folder: "{{ $.Values.grafanaFolder }}/"
  definition: |
{{ .Files.Get $path | indent 4 }}
---
{{- else }}
apiVersion: v1
kind: ConfigMap
metadata:
  annotations:
    {{- if $.Values.grafanaFolder }}
    grafana-dashboard-folder: /tmp/dashboards/{{ $.Values.grafanaFolder }}
    {{- else }}
    grafana-dashboard-folder: /tmp/dashboards/{{ default .Release.Namespace $dir }}{{ printf "-%s" .Release.Name }}
    {{- end }}
  name: dashboard-{{ .Release.Name }}-{{ $filename | replace ".json" "" }}
  labels:
    {{- include "dashboards.labels" . | nindent 4 }}
{{ toYaml $.Values.labels | indent 4 }}
data:
  {{ $filename }}: |-
{{ .Files.Get $path | indent 4 }}
---
{{- end }}
{{- end }}
{{- end }}
