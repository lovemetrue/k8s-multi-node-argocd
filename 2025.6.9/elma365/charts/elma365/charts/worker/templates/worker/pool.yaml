{{- $dot := . }}
{{- if .Values.global.helmLibrary }}
{{- $enabled := include "helm-library.worker-pool-enabled" . }}
{{- if $enabled }}

{{- range $poolKey, $poolValue := .Values.global.workerPoolCfg.pools }}

  {{- $nameParams := dict "GlobalContext" $dot "poolKey" $poolKey }}
  {{- $name := include "worker.pool.name" $nameParams }}
  {{- $queueName := printf "script.pool.%s" $poolKey }}
  {{- $autoscaling := $poolValue.autoscaling | default $dot.Values.global.autoscaling }}
  {{- $options := $poolValue.options }}
  {{- $localContext := dict "name" $name "queueName" $queueName "defaultPool" false "poolKey" $poolKey "autoscaling" $autoscaling "options" $options }}
  {{- $params := dict "GlobalContext" $dot "LocalContext" $localContext "Chart" $dot.Chart "Release" $dot.Release "Values" $dot.Values "Capabilities" $dot.Capabilities }}

{{- template "worker.deployment" $params }}
---
{{- template "worker.service" $params}}
---
{{- include "helm-library.hpa-worker" $params }}
---
{{- include "helm-library.keda-worker" $params }}
---
{{- include "helm-library.servicemonitor-worker" $params }}
{{- end }}

{{- end }}
{{- end }}
